<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Dark House | Flashlight Horror</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            overflow: hidden;
            background: #000;
            font-family: 'Courier New', monospace;
            color: white;
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        canvas {
            display: block;
        }
        
        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        
        #health {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 24px;
            color: #f00;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 5px;
            border: 1px solid #600;
        }
        
        #keys {
            position: absolute;
            top: 70px;
            left: 20px;
            font-size: 24px;
            color: #ff0;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 5px;
            border: 1px solid #660;
        }
        
        #sanctuary {
            position: absolute;
            top: 120px;
            left: 20px;
            font-size: 24px;
            color: #0af;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 5px;
            border: 1px solid #006;
        }
        
        #warning {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: #f00;
            text-shadow: 0 0 20px #f00;
            background: rgba(0,0,0,0.8);
            padding: 20px 40px;
            border-radius: 10px;
            border: 3px solid #f00;
            display: none;
        }
        
        #objective {
            position: absolute;
            bottom: 20px;
            left: 20px;
            font-size: 18px;
            color: #0f0;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 5px;
            border: 1px solid #060;
        }
        
        #stamina {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 200px;
            height: 20px;
            background: rgba(0,0,0,0.7);
            border: 1px solid #0af;
            border-radius: 3px;
            overflow: hidden;
        }
        
        #stamina-fill {
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, #0af, #0ff);
            transition: width 0.3s;
        }
        
        #stamina-text {
            position: absolute;
            bottom: 45px;
            right: 20px;
            color: #0af;
            font-size: 16px;
        }
        
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(0,0,0,0.9), rgba(20,0,0,0.9));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }
        
        #title {
            font-size: 72px;
            color: #b00;
            margin-bottom: 20px;
            text-shadow: 0 0 20px #f00;
            letter-spacing: 4px;
        }
        
        #subtitle {
            font-size: 24px;
            color: #aaa;
            margin-bottom: 50px;
        }
        
        #start-btn {
            background: #800;
            color: white;
            border: none;
            padding: 20px 50px;
            font-size: 28px;
            cursor: pointer;
            border-radius: 10px;
            margin-top: 30px;
            border: 2px solid #a00;
            transition: all 0.3s;
        }
        
        #start-btn:hover {
            background: #a00;
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(255,0,0,0.5);
        }
        
        #controls {
            position: absolute;
            bottom: 40px;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #444;
        }
        
        .key {
            display: inline-block;
            background: #333;
            padding: 5px 10px;
            margin: 0 5px;
            border-radius: 5px;
            border: 1px solid #555;
            font-family: monospace;
        }
        
        #game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30;
        }
        
        #game-over h1 {
            font-size: 72px;
            color: #f00;
            margin-bottom: 30px;
            text-shadow: 0 0 20px #f00;
        }
        
        #restart-btn {
            background: #800;
            color: white;
            border: none;
            padding: 20px 50px;
            font-size: 28px;
            cursor: pointer;
            border-radius: 10px;
            margin-top: 30px;
            border: 2px solid #a00;
            transition: all 0.3s;
        }
        
        #restart-btn:hover {
            background: #a00;
            transform: scale(1.05);
        }
        
        #win-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,20,0,0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30;
        }
        
        #win-screen h1 {
            font-size: 72px;
            color: #0f0;
            margin-bottom: 30px;
            text-shadow: 0 0 20px #0f0;
        }
        
        #continue-btn {
            background: #080;
            color: white;
            border: none;
            padding: 20px 50px;
            font-size: 28px;
            cursor: pointer;
            border-radius: 10px;
            margin-top: 30px;
            border: 2px solid #0a0;
            transition: all 0.3s;
        }
        
        #continue-btn:hover {
            background: #0a0;
            transform: scale(1.05);
        }
        
        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
        }
        
        .crosshair:before, .crosshair:after {
            content: '';
            position: absolute;
            background: rgba(255,255,255,0.8);
        }
        
        .crosshair:before {
            width: 20px;
            height: 2px;
            top: 9px;
            left: 0;
        }
        
        .crosshair:after {
            width: 2px;
            height: 20px;
            left: 9px;
            top: 0;
        }
        
        #sound-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: 1px solid #555;
            padding: 10px 20px;
            cursor: pointer;
            z-index: 40;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <div id="ui">
            <div id="health">HEALTH: 100</div>
            <div id="keys">KEYS: 0/5</div>
            <div id="sanctuary">SANCTUARY: 3</div>
            <div id="warning">IT'S CLOSE!</div>
            <div id="objective">Find 5 keys to unlock the front door</div>
            <div class="crosshair"></div>
            <div id="stamina">
                <div id="stamina-fill"></div>
            </div>
            <div id="stamina-text">STAMINA</div>
        </div>
        
        <div id="start-screen">
            <h1 id="title">THE DARK HOUSE</h1>
            <p id="subtitle">Your flashlight is the only thing between you and what's in the dark</p>
            <button id="start-btn">ENTER THE DARKNESS</button>
            <div id="controls">
                <p><span class="key">WASD</span> Move Around</p>
                <p><span class="key">MOUSE</span> Look Around</p>
                <p><span class="key">SHIFT</span> Run (uses stamina)</p>
                <p><span class="key">F</span> Toggle Flashlight</p>
                <p><span class="key">E</span> Pick Up Items / Open Door</p>
                <p><span class="key">SPACE</span> Use Sanctuary (when being chased)</p>
            </div>
        </div>
        
        <div id="game-over">
            <h1>YOU DIED</h1>
            <p style="font-size: 24px; margin-bottom: 30px;">The darkness has consumed you...</p>
            <button id="restart-btn">TRY AGAIN</button>
        </div>
        
        <div id="win-screen">
            <h1>ESCAPED!</h1>
            <p style="font-size: 24px; margin-bottom: 30px;">You found your way out of the darkness...</p>
            <button id="continue-btn">PLAY AGAIN</button>
        </div>
        
        <button id="sound-toggle">ðŸ”Š SOUND ON</button>
    </div>

    <script>
        // Game setup
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('start-screen');
        const gameOverScreen = document.getElementById('game-over');
        const winScreen = document.getElementById('win-screen');
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const continueBtn = document.getElementById('continue-btn');
        const soundToggle = document.getElementById('sound-toggle');
        const healthEl = document.getElementById('health');
        const keysEl = document.getElementById('keys');
        const sanctuaryEl = document.getElementById('sanctuary');
        const warningEl = document.getElementById('warning');
        const objectiveEl = document.getElementById('objective');
        const staminaFill = document.getElementById('stamina-fill');
        
        // Set canvas size
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        // Game state
        const game = {
            started: false,
            gameOver: false,
            won: false,
            player: {
                x: 400,
                y: 300,
                angle: 0,
                health: 100,
                keys: 0,
                maxKeys: 5,
                sanctuary: 3,
                speed: 3,
                isRunning: false,
                hasFlashlight: true,
                flashlightOn: true,
                stamina: 100,
                maxStamina: 100
            },
            enemy: {
                x: 1000,
                y: 600,
                speed: 1.8,
                chasing: false,
                detectionRange: 250,
                chaseRange: 500,
                attackRange: 30,
                lastSeenTime: 0
            },
            map: {
                width: 1200,
                height: 800,
                walls: [],
                keys: [],
                exit: {x: 600, y: 750, width: 100, height: 50}
            },
            darkness: 0.85,
            lastTime: 0,
            keys: {
                w: false,
                a: false,
                s: false,
                d: false,
                shift: false
            },
            mouseSensitivity: 0.002,
            soundEnabled: true
        };
        
        // Initialize game
        function init() {
            // Build the map
            buildMap();
            
            // Set up event listeners
            startBtn.addEventListener('click', startGame);
            restartBtn.addEventListener('click', restartGame);
            continueBtn.addEventListener('click', restartGame);
            soundToggle.addEventListener('click', toggleSound);
            
            document.addEventListener('keydown', (e) => {
                const key = e.key.toLowerCase();
                if (key in game.keys) {
                    game.keys[key] = true;
                }
                
                // Additional key presses
                if (game.started && !game.gameOver && !game.won) {
                    if (key === 'f') {
                        toggleFlashlight();
                    }
                    if (key === 'e') {
                        interact();
                    }
                    if (key === ' ') {
                        useSanctuary();
                    }
                }
            });
            
            document.addEventListener('keyup', (e) => {
                const key = e.key.toLowerCase();
                if (key in game.keys) {
                    game.keys[key] = false;
                }
            });
            
            document.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('click', () => {
                if (game.started && !game.gameOver && !game.won) {
                    canvas.requestPointerLock();
                }
            });
            
            // Start game loop
            requestAnimationFrame(gameLoop);
        }
        
        // Build the map
        function buildMap() {
            // Clear existing map
            game.map.walls = [];
            game.map.keys = [];
            
            // Outer walls
            game.map.walls.push({x: 100, y: 100, width: 1000, height: 20}); // top
            game.map.walls.push({x: 100, y: 680, width: 1000, height: 20}); // bottom
            game.map.walls.push({x: 100, y: 100, width: 20, height: 600}); // left
            game.map.walls.push({x: 1080, y: 100, width: 20, height: 600}); // right
            
            // Interior walls (rooms)
            game.map.walls.push({x: 100, y: 300, width: 300, height: 20}); // room divider 1
            game.map.walls.push({x: 100, y: 500, width: 300, height: 20}); // room divider 2
            game.map.walls.push({x: 400, y: 100, width: 20, height: 200}); // vertical divider
            game.map.walls.push({x: 400, y: 400, width: 20, height: 300}); // vertical divider 2
            game.map.walls.push({x: 600, y: 100, width: 20, height: 300}); // room divider 3
            game.map.walls.push({x: 800, y: 400, width: 20, height: 300}); // room divider 4
            
            // Keys positions
            game.map.keys = [
                {x: 200, y: 200, collected: false},
                {x: 350, y: 400, collected: false},
                {x: 500, y: 250, collected: false},
                {x: 700, y: 500, collected: false},
                {x: 900, y: 200, collected: false}
            ];
            
            // Reset player position
            game.player.x = 200;
            game.player.y = 200;
            game.player.angle = 0;
            
            // Reset enemy position
            game.enemy.x = 900;
            game.enemy.y = 600;
            game.enemy.chasing = false;
            
            // Reset player stats
            game.player.health = 100;
            game.player.keys = 0;
            game.player.sanctuary = 3;
            game.player.stamina = 100;
            
            // Update UI
            updateUI();
        }
        
        // Start the game
        function startGame() {
            game.started = true;
            startScreen.style.display = 'none';
            
            // Request pointer lock for mouse controls
            canvas.requestPointerLock = canvas.requestPointerLock || canvas.mozRequestPointerLock;
            canvas.requestPointerLock();
        }
        
        // Restart the game
        function restartGame() {
            game.gameOver = false;
            game.won = false;
            gameOverScreen.style.display = 'none';
            winScreen.style.display = 'none';
            
            // Rebuild map and reset positions
            buildMap();
            
            // Start with flashlight on
            game.player.flashlightOn = true;
            game.darkness = 0.85;
        }
        
        // Toggle sound
        function toggleSound() {
            game.soundEnabled = !game.soundEnabled;
            soundToggle.textContent = game.soundEnabled ? 'ðŸ”Š SOUND ON' : 'ðŸ”‡ SOUND OFF';
        }
        
        // Handle mouse movement
        function handleMouseMove(e) {
            if (!game.started || game.gameOver || game.won) return;
            
            const movementX = e.movementX || e.mozMovementX || 0;
            game.player.angle += movementX * game.mouseSensitivity;
            
            // Keep angle normalized
            if (game.player.angle > Math.PI * 2) game.player.angle -= Math.PI * 2;
            if (game.player.angle < 0) game.player.angle += Math.PI * 2;
        }
        
        // Toggle flashlight
        function toggleFlashlight() {
            if (game.player.hasFlashlight) {
                game.player.flashlightOn = !game.player.flashlightOn;
                game.darkness = game.player.flashlightOn ? 0.7 : 0.95;
            }
        }
        
        // Use sanctuary
        function useSanctuary() {
            if (game.player.sanctuary > 0 && game.enemy.chasing) {
                game.player.sanctuary--;
                game.enemy.chasing = false;
                game.enemy.x = 900;
                game.enemy.y = 600;
                updateUI();
                
                // Visual effect
                game.darkness = 0.5;
                setTimeout(() => {
                    game.darkness = game.player.flashlightOn ? 0.7 : 0.95;
                }, 1000);
            }
        }
        
        // Interact with objects
        function interact() {
            // Check for keys
            for (const key of game.map.keys) {
                if (!key.collected) {
                    const dx = key.x - game.player.x;
                    const dy = key.y - game.player.y;
                    const distance = Math.sqrt(dx*dx + dy*dy);
                    
                    if (distance < 40) {
                        key.collected = true;
                        game.player.keys++;
                        updateUI();
                        
                        if (game.player.keys === game.player.maxKeys) {
                            objectiveEl.textContent = "Find the exit door and escape!";
                            objectiveEl.style.color = "#0f0";
                        } else {
                            objectiveEl.textContent = `Keys found: ${game.player.keys}/${game.player.maxKeys}`;
                        }
                        return;
                    }
                }
            }
            
            // Check for exit door
            const exit = game.map.exit;
            const dx = exit.x + exit.width/2 - game.player.x;
            const dy = exit.y + exit.height/2 - game.player.y;
            const distance = Math.sqrt(dx*dx + dy*dy);
            
            if (distance < 80) {
                if (game.player.keys >= game.player.maxKeys) {
                    // Win the game
                    game.won = true;
                    winScreen.style.display = 'flex';
                } else {
                    objectiveEl.textContent = `Need ${game.player.maxKeys - game.player.keys} more key(s)`;
                    objectiveEl.style.color = "#f00";
                    setTimeout(() => {
                        objectiveEl.textContent = `Keys found: ${game.player.keys}/${game.player.maxKeys}`;
                        objectiveEl.style.color = "#0f0";
                    }, 2000);
                }
            }
        }
        
        // Update player movement
        function updatePlayer(deltaTime) {
            // Determine movement direction
            let moveX = 0;
            let moveY = 0;
            
            if (game.keys.w) {
                moveX += Math.cos(game.player.angle);
                moveY += Math.sin(game.player.angle);
            }
            if (game.keys.s) {
                moveX -= Math.cos(game.player.angle);
                moveY -= Math.sin(game.player.angle);
            }
            if (game.keys.a) {
                moveX += Math.cos(game.player.angle - Math.PI/2);
                moveY += Math.sin(game.player.angle - Math.PI/2);
            }
            if (game.keys.d) {
                moveX += Math.cos(game.player.angle + Math.PI/2);
                moveY += Math.sin(game.player.angle + Math.PI/2);
            }
            
            // Normalize diagonal movement
            const length = Math.sqrt(moveX*moveX + moveY*moveY);
            if (length > 0) {
                moveX /= length;
                moveY /= length;
            }
            
            // Apply speed
            let speed = game.player.speed;
            game.player.isRunning = false;
            
            if (game.keys.shift && game.player.stamina > 0) {
                speed *= 1.8;
                game.player.isRunning = true;
                game.player.stamina = Math.max(0, game.player.stamina - 40 * deltaTime);
            } else if (!game.keys.shift) {
                game.player.stamina = Math.min(game.player.maxStamina, game.player.stamina + 20 * deltaTime);
            }
            
            // Update stamina UI
            staminaFill.style.width = (game.player.stamina / game.player.maxStamina * 100) + '%';
            
            // Calculate new position
            const newX = game.player.x + moveX * speed * deltaTime * 60;
            const newY = game.player.y + moveY * speed * deltaTime * 60;
            
            // Check collision
            if (!checkCollision(newX, game.player.y)) {
                game.player.x = newX;
            }
            if (!checkCollision(game.player.x, newY)) {
                game.player.y = newY;
            }
            
            // Keep player in bounds
            game.player.x = Math.max(120, Math.min(game.map.width - 120, game.player.x));
            game.player.y = Math.max(120, Math.min(game.map.height - 120, game.player.y));
        }
        
        // Check collision with walls
        function checkCollision(x, y) {
            const playerRadius = 20;
            
            for (const wall of game.map.walls) {
                // Check if player circle collides with wall rectangle
                const closestX = Math.max(wall.x, Math.min(x, wall.x + wall.width));
                const closestY = Math.max(wall.y, Math.min(y, wall.y + wall.height));
                
                const distanceX = x - closestX;
                const distanceY = y - closestY;
                const distance = Math.sqrt(distanceX*distanceX + distanceY*distanceY);
                
                if (distance < playerRadius) {
                    return true;
                }
            }
            return false;
        }
        
        // Update enemy AI
        function updateEnemy(deltaTime) {
            const dx = game.player.x - game.enemy.x;
            const dy = game.player.y - game.enemy.y;
            const distance = Math.sqrt(dx*dx + dy*dy);
            
            // Update warning
            if (distance < 150 && game.enemy.chasing) {
                warningEl.style.display = 'block';
                const intensity = 1 - (distance / 150);
                warningEl.style.fontSize = 36 + intensity * 24 + 'px';
                warningEl.style.opacity = intensity;
            } else {
                warningEl.style.display = 'none';
            }
            
            // Enemy behavior
            if (!game.enemy.chasing) {
                // Patrol mode
                if (distance < game.enemy.detectionRange) {
                    game.enemy.chasing = true;
                    game.enemy.lastSeenTime = Date.now();
                } else {
                    // Random patrol movement
                    if (Math.random() < 0.01) {
                        game.enemy.x += (Math.random() - 0.5) * 100;
                        game.enemy.y += (Math.random() - 0.5) * 100;
                    }
                }
            } else {
                // Chase mode
                if (Date.now() - game.enemy.lastSeenTime > 10000) {
                    // Give up chase after 10 seconds
                    game.enemy.chasing = false;
                } else {
                    // Move towards player
                    const angle = Math.atan2(dy, dx);
                    game.enemy.x += Math.cos(angle) * game.enemy.speed * deltaTime * 60;
                    game.enemy.y += Math.sin(angle) * game.enemy.speed * deltaTime * 60;
                    
                    // Keep enemy in bounds
                    game.enemy.x = Math.max(120, Math.min(game.map.width - 120, game.enemy.x));
                    game.enemy.y = Math.max(120, Math.min(game.map.height - 120, game.enemy.y));
                    
                    // Check attack
                    if (distance < game.enemy.attackRange) {
                        attackPlayer();
                    }
                    
                    // Update last seen time
                    if (distance < game.enemy.chaseRange) {
                        game.enemy.lastSeenTime = Date.now();
                    }
                }
            }
        }
        
        // Attack player
        function attackPlayer() {
            game.player.health -= 25;
            updateUI();
            
            // Visual feedback
            canvas.style.backgroundColor = '#f00';
            setTimeout(() => {
                canvas.style.backgroundColor = '#000';
            }, 100);
            
            // Check game over
            if (game.player.health <= 0) {
                game.player.health = 0;
                game.gameOver = true;
                gameOverScreen.style.display = 'flex';
            }
        }
        
        // Update UI
        function updateUI() {
            healthEl.textContent = `HEALTH: ${Math.max(0, game.player.health)}`;
            keysEl.textContent = `KEYS: ${game.player.keys}/${game.player.maxKeys}`;
            sanctuaryEl.textContent = `SANCTUARY: ${game.player.sanctuary}`;
            
            // Update health color
            if (game.player.health > 60) {
                healthEl.style.color = '#0f0';
            } else if (game.player.health > 30) {
                healthEl.style.color = '#ff0';
            } else {
                healthEl.style.color = '#f00';
                healthEl.classList.add('pulse');
            }
        }
        
        // Draw the game
        function draw() {
            // Clear canvas
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (!game.started) return;
            
            // Draw from player's perspective
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // Draw floor (simple)
            ctx.fillStyle = '#222';
            ctx.fillRect(0, centerY, canvas.width, canvas.height - centerY);
            
            // Draw ceiling
            ctx.fillStyle = '#111';
            ctx.fillRect(0, 0, canvas.width, centerY);
            
            // Draw walls (simplified 3D)
            drawWalls();
            
            // Draw keys
            drawKeys();
            
            // Draw enemy
            drawEnemy();
            
            // Draw exit door
            drawExit();
            
            // Apply darkness overlay
            ctx.fillStyle = `rgba(0, 0, 0, ${game.darkness})`;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw flashlight effect if on
            if (game.player.flashlightOn) {
                const gradient = ctx.createRadialGradient(
                    centerX, centerY, 100,
                    centerX, centerY, 500
                );
                gradient.addColorStop(0, 'rgba(255, 255, 200, 0.1)');
                gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        }
        
        // Draw walls
        function drawWalls() {
            ctx.fillStyle = '#8B4513';
            
            for (const wall of game.map.walls) {
                const dx = wall.x - game.player.x;
                const dy = wall.y - game.player.y;
                const distance = Math.sqrt(dx*dx + dy*dy);
                
                if (distance < 400) {
                    const angle = Math.atan2(dy, dx) - game.player.angle;
                    
                    // Only draw if in front of player
                    if (Math.abs(angle) < Math.PI / 2) {
                        const screenX = centerX + (angle * 300);
                        const height = Math.max(10, 3000 / distance);
                        const width = Math.max(10, wall.width * 80 / distance);
                        
                        const y = canvas.height / 2 - height / 2;
                        
                        // Draw wall
                        ctx.fillStyle = '#8B4513';
                        ctx.fillRect(screenX - width/2, y, width, height);
                        
                        // Add wood texture
                        ctx.fillStyle = '#A0522D';
                        for (let i = 0; i < 5; i++) {
                            const lineY = y + i * (height / 5);
                            ctx.fillRect(screenX - width/2, lineY, width, 2);
                        }
                    }
                }
            }
        }
        
        // Draw keys
        function drawKeys() {
            for (const key of game.map.keys) {
                if (!key.collected) {
                    const dx = key.x - game.player.x;
                    const dy = key.y - game.player.y;
                    const distance = Math.sqrt(dx*dx + dy*dy);
                    
                    if (distance < 200) {
                        const angle = Math.atan2(dy, dx) - game.player.angle;
                        
                        if (Math.abs(angle) < Math.PI / 2) {
                            const screenX = centerX + (angle * 300);
                            const size = Math.max(10, 100 / distance * 30);
                            
                            // Draw glowing key
                            ctx.fillStyle = '#ff0';
                            ctx.beginPath();
                            ctx.arc(screenX, centerY, size/2, 0, Math.PI * 2);
                            ctx.fill();
                            
                            // Add glow
                            ctx.fillStyle = 'rgba(255, 255, 0, 0.3)';
                            ctx.beginPath();
                            ctx.arc(screenX, centerY, size, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                }
            }
        }
        
        // Draw enemy
        function drawEnemy() {
            const dx = game.enemy.x - game.player.x;
            const dy = game.enemy.y - game.player.y;
            const distance = Math.sqrt(dx*dx + dy*dy);
            
            if (distance < 300) {
                const angle = Math.atan2(dy, dx) - game.player.angle;
                
                if (Math.abs(angle) < Math.PI / 2) {
                    const screenX = centerX + (angle * 300);
                    const size = Math.max(20, 150 / distance * 40);
                    
                    // Draw enemy shadow
                    const gradient = ctx.createRadialGradient(
                        screenX, centerY, size/2,
                        screenX, centerY, size
                    );
                    gradient.addColorStop(0, 'rgba(150, 0, 0, 0.8)');
                    gradient.addColorStop(1, 'rgba(50, 0, 0, 0)');
                    
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(screenX, centerY, size, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Draw enemy body
                    ctx.fillStyle = game.enemy.chasing ? '#f00' : '#800';
                    ctx.beginPath();
                    ctx.arc(screenX, centerY, size/2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Draw eyes when chasing
                    if (game.enemy.chasing) {
                        ctx.fillStyle = '#fff';
                        ctx.beginPath();
                        ctx.arc(screenX - size/4, centerY - size/8, size/8, 0, Math.PI * 2);
                        ctx.arc(screenX + size/4, centerY - size/8, size/8, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
            }
        }
        
        // Draw exit door
        function drawExit() {
            const dx = game.map.exit.x - game.player.x;
            const dy = game.map.exit.y - game.player.y;
            const distance = Math.sqrt(dx*dx + dy*dy);
            
            if (distance < 400) {
                const angle = Math.atan2(dy, dx) - game.player.angle;
                
                if (Math.abs(angle) < Math.PI / 2) {
                    const screenX = centerX + (angle * 300);
                    const height = Math.max(20, 2000 / distance);
                    const width = Math.max(10, game.map.exit.width * 60 / distance);
                    
                    const y = canvas.height / 2 - height / 2;
                    
                    // Draw door
                    ctx.fillStyle = game.player.keys >= game.player.maxKeys ? '#0a0' : '#a00';
                    ctx.fillRect(screenX - width/2, y, width, height);
                    
                    // Draw door frame
                    ctx.strokeStyle = '#654321';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(screenX - width/2, y, width, height);
                }
            }
        }
        
        // Game loop
        function gameLoop(currentTime) {
            // Calculate delta time
            const deltaTime = (currentTime - game.lastTime) / 1000 || 0;
            game.lastTime = currentTime;
            
            // Update game state
            if (game.started && !game.gameOver && !game.won) {
                updatePlayer(deltaTime);
                updateEnemy(deltaTime);
            }
            
            // Draw everything
            draw();
            
            // Continue loop
            requestAnimationFrame(gameLoop);
        }
        
        // Handle window resize
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            centerX = canvas.width / 2;
            centerY = canvas.height / 2;
        });
        
        // Global center variables for drawing
        let centerX = canvas.width / 2;
        let centerY = canvas.height / 2;
        
        // Initialize the game
        window.addEventListener('load', init);
    </script>
</body>
</html>
